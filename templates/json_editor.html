{% extends "base.html" %}

{% block content %}
<header>
    <h1>üìÑ Editor JSON</h1>
    <p class="text-muted">Edita directamente el archivo cv_data.json (para usuarios avanzados)</p>
</header>

<div class="card">
    <div class="json-editor-container"
        style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: start;">
        <!-- Columna Izquierda: Visor del JSON -->
        <div class="json-viewer-column">
            <div style="margin-bottom: 1rem;">
                <p class="text-muted" style="font-size: 0.95rem;">
                    ‚ö†Ô∏è <strong>Advertencia:</strong> Edita con cuidado. Un JSON inv√°lido puede causar errores en la
                    aplicaci√≥n.
                </p>
            </div>

            <textarea id="jsonEditor" class="json-editor" placeholder="Cargando JSON..."
                style="height: 600px; overflow-y: auto; resize: vertical;"></textarea>
        </div>

        <!-- Columna Derecha: Botones de Acci√≥n -->
        <div class="json-actions-column" style="display: flex; flex-direction: column; gap: 1rem;">
            <div
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 12px; color: white;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 600;">Acciones</h3>
                <p style="margin: 0; font-size: 0.85rem; opacity: 0.9;">Gestiona tu archivo JSON</p>
            </div>

            <button id="reloadJsonBtn" class="btn-add-skill"
                style="background: #6b7280; width: 100%; justify-content: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                </svg>
                Recargar JSON
            </button>

            <button id="saveJsonBtn" class="btn-add-skill" style="width: 100%; justify-content: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Guardar JSON
            </button>

            <button id="copyJsonBtn" class="btn-add-skill"
                style="background: #10b981; width: 100%; justify-content: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copiar JSON
            </button>

            <!-- Mensaje de Estado debajo de los botones -->
            <div id="jsonStatus" style="display: none; margin-top: 0.5rem;"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const jsonEditor = document.getElementById('jsonEditor');
        const saveJsonBtn = document.getElementById('saveJsonBtn');
        const reloadJsonBtn = document.getElementById('reloadJsonBtn');
        const copyJsonBtn = document.getElementById('copyJsonBtn');
        const jsonStatus = document.getElementById('jsonStatus');

        // JSON Editor Functions
        function loadJsonEditor() {
            fetch('/get_cv_data')
                .then(response => response.json())
                .then(data => {
                    if (jsonEditor) {
                        jsonEditor.value = JSON.stringify(data, null, 4);
                    }
                })
                .catch(err => {
                    console.error('Error loading JSON:', err);
                    showJsonStatus('Error al cargar JSON', 'error');
                });
        }

        function showJsonStatus(message, type) {
            if (jsonStatus) {
                jsonStatus.textContent = message;
                jsonStatus.className = `json-status ${type}`;
                jsonStatus.style.display = 'block';

                setTimeout(() => {
                    jsonStatus.style.display = 'none';
                }, 3000);
            }
        }

        if (saveJsonBtn) {
            saveJsonBtn.addEventListener('click', () => {
                try {
                    const jsonText = jsonEditor.value;
                    const parsedData = JSON.parse(jsonText);

                    saveJsonBtn.disabled = true;

                    fetch('/save_cv_data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(parsedData),
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                showJsonStatus('‚úì JSON guardado correctamente', 'success');
                                // Reload after a short delay
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            } else {
                                showJsonStatus('‚úó Error al guardar JSON', 'error');
                            }
                        })
                        .catch(err => {
                            console.error('Error:', err);
                            showJsonStatus('‚úó Error de conexi√≥n', 'error');
                        })
                        .finally(() => {
                            saveJsonBtn.disabled = false;
                        });
                } catch (e) {
                    showJsonStatus('‚úó JSON inv√°lido: ' + e.message, 'error');
                }
            });
        }

        if (reloadJsonBtn) {
            reloadJsonBtn.addEventListener('click', () => {
                loadJsonEditor();
                showJsonStatus('‚úì JSON recargado', 'success');
            });
        }

        if (copyJsonBtn) {
            copyJsonBtn.addEventListener('click', async () => {
                try {
                    const jsonText = jsonEditor.value;
                    await navigator.clipboard.writeText(jsonText);
                    showJsonStatus('‚úì JSON copiado al portapapeles', 'success');
                } catch (err) {
                    console.error('Error al copiar:', err);
                    showJsonStatus('‚úó Error al copiar JSON', 'error');
                }
            });
        }

        // Keyboard shortcut: Ctrl+S to save
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveJsonBtn.click();
            }
        });

        // Load JSON on page load
        loadJsonEditor();
    });
</script>
{% endblock %}